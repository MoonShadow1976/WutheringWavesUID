name: pre-commit

on:
  pull_request:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  pre-commit-checks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Run pre-commit hooks
        id: precommit
        continue-on-error: true
        uses: pre-commit/action@v3.0.0

      - name: Check for changes
        id: check-changes
        if: always() && github.event_name == 'push'  # åªåœ¨ push æ—¶æ£€æŸ¥
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ ¼å¼åŒ–ä¿®æ”¹ï¼Œå‡†å¤‡æäº¤..."
            git status --short
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          # æ£€æŸ¥ä¸Šæ¬¡æäº¤æ˜¯å¦ä¹Ÿæ˜¯è‡ªåŠ¨æ ¼å¼åŒ–
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$LAST_COMMIT_MSG" == *"è‡ªåŠ¨æ ¼å¼åŒ–"* ]] || [[ "$LAST_COMMIT_MSG" == *"[skip ci]"* ]]; then
            echo "è·³è¿‡æäº¤ï¼šä¸Šæ¬¡æäº¤å·²ç»æ˜¯æ ¼å¼åŒ–æ“ä½œ"
            exit 0
          fi
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "style: è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç  [skip ci]"
          git push
          echo "âœ… å·²è‡ªåŠ¨æäº¤æ ¼å¼åŒ–ä¿®æ”¹"

      - name: Status Report
        run: |
          if [ "${{ steps.precommit.outcome }}" = "failure" ]; then
            echo "## ğŸš¨ Pre-commit Status" >> $GITHUB_STEP_SUMMARY
            echo "**æ£€æµ‹åˆ°æ ¼å¼åŒ–é—®é¢˜**" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ github.event_name }}" = "push" ]; then
              if [ "${{ steps.check-changes.outputs.changes }}" = "true" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "âœ… å·²è‡ªåŠ¨ä¿®å¤å¹¶æäº¤ä»£ç æ ¼å¼" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "**Failed for Python ${{ matrix.python-version }}**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
              echo "|------|------|" >> $GITHUB_STEP_SUMMARY
              echo "| Python ${{ matrix.python-version }} | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**å¦‚ä½•ä¿®å¤:**" >> $GITHUB_STEP_SUMMARY
              echo "- æœ¬åœ°è¿è¡Œ: \`pre-commit run --all-files\`" >> $GITHUB_STEP_SUMMARY
              echo "- æˆ–è€…: \`pre-commit run ruff --all-files && pre-commit run ruff-format --all-files\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âœ… Pre-commit Status" >> $GITHUB_STEP_SUMMARY
            echo "**æ‰€æœ‰æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ github.event_name }}" = "push" ] && [ "${{ steps.check-changes.outputs.changes }}" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… å·²è‡ªåŠ¨æäº¤æ ¼å¼åŒ–ä¿®æ”¹" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Fail for PR only
        if: github.event_name == 'pull_request' && steps.precommit.outcome == 'failure'
        run: |
          echo "âŒ PR éœ€è¦å…ˆä¿®å¤ä»£ç æ ¼å¼é—®é¢˜"
          exit 1